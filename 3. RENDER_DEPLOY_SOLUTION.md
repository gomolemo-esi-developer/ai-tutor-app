# TutorVerse Render.com Deployment - Complete Solution

## Critical Issues Found & Fixes

### 1. **Frontend Nginx Proxy Configuration**
**Problem**: The nginx config (`nginx.conf`) proxies to `http://backend:3000` which only works on Docker bridge networks. On Render, services are separate and must use HTTPS URLs.

**Fix**: Modify `nginx.conf` to use environment variables for the API URL.

**Current (BROKEN for Render)**:
```nginx
location /api/ {
    proxy_pass http://backend:3000;  # ❌ Won't work on Render
}
```

**Updated (WORKS for Render)**:
```nginx
location /api/ {
    proxy_pass ${BACKEND_URL};
}
```

---

### 2. **Frontend Build ARG Issue**
**Problem**: Frontend Dockerfile accepts `VITE_API_URL` as a build argument, but Render environment variables won't be passed during build.

**Fix**: Change approach - use environment variable substitution at runtime via nginx.

---

### 3. **Environment Variable Mismatch**
**Problem**: `render.yaml` uses placeholder syntax `${RAG_SERVICE_URL}` and `${BACKEND_SERVICE_URL}` that Render won't interpolate automatically.

**Fix**: Services must explicitly set each other's URLs after deployment, or use a better substitution approach.

---

### 4. **Volume/Persistence Data Loss**
**Problem**: 
- RAG service stores data in `/app/chroma_db` and `/app/data` volumes
- Render free tier has no persistent volumes
- Data will be lost on every deployment

**Fix**: For production use, upgrade to Render's Disk storage or use external database.

---

## Step-by-Step Deployment Solution

### Phase 0: Pre-Deployment Fixes

#### A. Create Dynamic Nginx Configuration
Create a new startup script for the frontend:

**File: `docker-entrypoint.sh`**
```bash
#!/bin/sh
# Substitute environment variables in nginx config
cat > /etc/nginx/conf.d/default.conf <<EOF
server {
    listen 3000;
    server_name _;

    root /app/dist;
    index index.html;

    location /api/ {
        proxy_pass \${BACKEND_URL};
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }

    location / {
        try_files \$uri \$uri/ /index.html;
    }
}
EOF

# Start nginx
nginx -g 'daemon off;'
EOF
chmod +x docker-entrypoint.sh
```

#### B. Update Frontend Dockerfile
```dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY ai-tutor-app/tutorverse-hub-main/package*.json ./
RUN npm ci

COPY ai-tutor-app/tutorverse-hub-main/src ./src
COPY ai-tutor-app/tutorverse-hub-main/public ./public
COPY ai-tutor-app/tutorverse-hub-main/index.html ./
COPY ai-tutor-app/tutorverse-hub-main/vite.config.ts ./
COPY ai-tutor-app/tutorverse-hub-main/tsconfig*.json ./
COPY ai-tutor-app/tutorverse-hub-main/tailwind.config.ts ./
COPY ai-tutor-app/tutorverse-hub-main/postcss.config.js ./
COPY ai-tutor-app/tutorverse-hub-main/components.json ./
COPY ai-tutor-app/tutorverse-hub-main/eslint.config.js ./

RUN npm run build

# Production stage
FROM nginx:alpine

WORKDIR /app

COPY --from=builder /app/dist ./dist
COPY docker-entrypoint.sh /docker-entrypoint.sh

RUN chmod +x /docker-entrypoint.sh

RUN addgroup -g 1001 -S nginx && \
    adduser -S nginx -u 1001 || true

EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
  CMD wget --quiet --tries=1 --spider http://localhost:3000/ || exit 1

ENTRYPOINT ["/docker-entrypoint.sh"]
```

---

### Phase 1: Deploy to Render (Manual Steps)

#### Step 1: Push Updated Code to GitHub
```bash
git add -A
git commit -m "Fix Render deployment: dynamic nginx config and proper env vars"
git push origin main
```

#### Step 2: Deploy RAG Service (FIRST - Backend Dependency)

1. Go to https://dashboard.render.com
2. Click **New +** → **Web Service**
3. Connect GitHub repo
4. Configure:

| Setting | Value |
|---------|-------|
| **Name** | `tutorverse-rag` |
| **Environment** | Docker |
| **Region** | `oregon` (or your region) |
| **Branch** | `main` |
| **Dockerfile Path** | `./Dockerfile.rag` |
| **Instance Type** | `Starter` ($12/month) - **REQUIRED** for RAG |

5. Set **Environment Variables** (Advanced tab):
   ```
   OPENAI_API_KEY=sk-xxxxxxxxxxxx (your key)
   ENVIRONMENT=production
   PYTHONUNBUFFERED=1
   CHROMA_PERSIST_DIR=/app/chroma_db
   ```

6. **Optional but Recommended**: Add Render Disk
   - Settings → Disk
   - Add disk at `/app/chroma_db` (10GB should suffice)
   - Add disk at `/app/data` (5GB)

7. Click **Create Web Service**

⏳ Wait for deployment (5-10 minutes). Note the URL: `https://tutorverse-rag.onrender.com`

---

#### Step 3: Deploy Backend Service

1. Click **New +** → **Web Service**
2. Configure:

| Setting | Value |
|---------|-------|
| **Name** | `tutorverse-backend` |
| **Environment** | Docker |
| **Region** | Same as RAG |
| **Branch** | `main` |
| **Dockerfile Path** | `./Dockerfile.backend` |
| **Instance Type** | `Starter` ($12/month) minimum |

3. **Environment Variables**:
   ```
   NODE_ENV=production
   AWS_REGION=us-east-2
   ENVIRONMENT=production
   RAG_SERVICE_URL=https://tutorverse-rag.onrender.com
   RAG_ENABLE=true
   RAG_TIMEOUT=30000
   RAG_RETRY_ATTEMPTS=3
   ```

4. Click **Create Web Service**

⏳ Wait for deployment. Note the URL: `https://tutorverse-backend.onrender.com`

---

#### Step 4: Deploy Frontend Service

1. Click **New +** → **Web Service**
2. Configure:

| Setting | Value |
|---------|-------|
| **Name** | `ai-tutor` |
| **Environment** | Docker |
| **Region** | Same as others |
| **Branch** | `main` |
| **Dockerfile Path** | `./Dockerfile.frontend` |
| **Instance Type** | Free tier (static files only) |

3. **Environment Variables**:
   ```
   BACKEND_URL=https://tutorverse-backend.onrender.com
   NODE_ENV=production
   ```

4. Click **Create Web Service**

⏳ Wait for deployment. Note the URL: `https://ai-tutor.onrender.com`

---

### Phase 2: Post-Deployment Verification

#### Test Each Service

```bash
# 1. Frontend loads
curl -I https://ai-tutor.onrender.com
# Expected: 200 OK

# 2. Backend health
curl https://tutorverse-backend.onrender.com/health
# Expected: {"status":"ok"} or similar

# 3. RAG health
curl https://tutorverse-rag.onrender.com/health
# Expected: {"status":"ok"} or similar

# 4. Frontend → Backend communication
# Visit https://ai-tutor.onrender.com and check browser console
# Should see successful API calls to https://tutorverse-backend.onrender.com
```

#### Check Logs
- Each service dashboard → **Logs** tab
- Look for startup errors
- Check for connection timeouts

---

## Common Render Deployment Errors & Fixes

### Error 1: "Failed to build image"
**Cause**: Missing files or wrong Dockerfile path
**Fix**: 
```bash
# Verify locally:
docker build -f Dockerfile.frontend .
docker build -f Dockerfile.backend .
docker build -f Dockerfile.rag .
```

### Error 2: "Service health check failing"
**Cause**: Endpoint not ready, service not starting
**Fix**:
- Increase health check delay: Settings → Health Check → Start period to 60s
- Check logs for startup errors
- Verify port is 3000 for frontend/backend, 8000 for RAG

### Error 3: "Frontend can't reach Backend"
**Cause**: `BACKEND_URL` env var not set correctly
**Fix**:
- Verify Frontend has `BACKEND_URL=https://tutorverse-backend.onrender.com`
- Check nginx logs: Dashboard → Logs
- Verify nginx config was generated correctly

### Error 4: "Backend can't reach RAG"
**Cause**: `RAG_SERVICE_URL` not using HTTPS or wrong hostname
**Fix**:
- Must use: `https://tutorverse-rag.onrender.com` (with HTTPS)
- Check backend logs for connection errors
- Increase RAG_TIMEOUT if responses are slow

### Error 5: "Build timeout (>1 hour)"
**Cause**: RAG dependencies taking too long to install
**Fix**:
- Upgrade instance type to `Standard` or higher
- Or: Remove unused dependencies from `RAG18Nov2025-1/requirements.txt`

### Error 6: "Service keeps restarting"
**Cause**: Out of memory or unhandled errors
**Fix**:
- Check logs for error patterns
- Upgrade instance type
- Reduce memory-intensive operations

---

## Environment Variables Reference

### RAG Service
```
OPENAI_API_KEY         (REQUIRED - your OpenAI API key)
ENVIRONMENT            = production
PYTHONUNBUFFERED       = 1
CHROMA_PERSIST_DIR     = /app/chroma_db
```

### Backend Service
```
NODE_ENV               = production
AWS_REGION             = us-east-2
ENVIRONMENT            = production
RAG_SERVICE_URL        = https://tutorverse-rag.onrender.com
RAG_ENABLE             = true
RAG_TIMEOUT            = 30000
RAG_RETRY_ATTEMPTS     = 3
```

### Frontend Service
```
BACKEND_URL            = https://tutorverse-backend.onrender.com
NODE_ENV               = production
```

---

## Cost Breakdown (Monthly)

| Service | Instance | Cost | Notes |
|---------|----------|------|-------|
| **Frontend** | Free | $0 | Static files only |
| **Backend** | Starter | $12 | Node.js API, minimal memory |
| **RAG** | Starter+ | $25+ | ML workload, requires more resources |
| **Disk** (optional) | 10GB | $0.10/GB | ~$1/month for persistence |
| **TOTAL** | - | **$37+** | Minimum for production |

**Tip**: Start with free tiers, upgrade only if needed.

---

## Production Deployment Checklist

- [ ] Code pushed to GitHub
- [ ] All Dockerfiles build locally without errors
- [ ] Environment variables prepared (OPENAI_API_KEY, etc.)
- [ ] `docker-entrypoint.sh` created and committed
- [ ] `Dockerfile.frontend` updated with entrypoint
- [ ] RAG service deployed and URL noted
- [ ] Backend service deployed with RAG_SERVICE_URL set
- [ ] Frontend service deployed with BACKEND_URL set
- [ ] All health endpoints responding (200 OK)
- [ ] Frontend loads in browser
- [ ] API calls successful in browser console
- [ ] Logs reviewed for errors
- [ ] Monitoring/alerting configured (optional)

---

## Rollback Procedure

If something breaks:
1. Dashboard → Service → **Deployments** tab
2. Find last successful deployment
3. Click **Deploy**
4. Render rebuilds from that commit

---

## Next Steps

1. **Create `docker-entrypoint.sh`** in root directory
2. **Update `Dockerfile.frontend`** to use entrypoint
3. **Commit and push** to GitHub
4. **Follow Phase 1** deployment steps
5. **Verify** all services in Phase 2
6. **Monitor** logs daily for errors

---

## Support Resources

- **Render Docs**: https://render.com/docs
- **Docker Docs**: https://docs.docker.com
- **Nginx Proxy**: https://nginx.org/en/docs/http/ngx_http_proxy_module.html
- **This Project Repo**: Check GitHub issues and README
