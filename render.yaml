services:
  # RAG Service (DEPLOY FIRST - Backend Dependency)
  - type: web
    name: tutorverse-rag
    runtime: docker
    region: oregon
    plan: standard
    dockerfilePath: ./Dockerfile.rag
    autoDeploy: true
    healthCheckPath: /health
    healthCheckStartPeriod: 60
    envVars:
      - key: OPENAI_API_KEY
        scope: RUN
        sync: false  # Set manually in Render dashboard
      - key: ENVIRONMENT
        value: production
      - key: PYTHONUNBUFFERED
        value: '1'
      - key: CHROMA_PERSIST_DIR
        value: /app/chroma_db
    
    # Optional: Add persistent disk for data
    # disk:
    #   name: rag-data
    #   mountPath: /app/chroma_db
    #   sizeGB: 10

  # Backend Service (DEPLOY SECOND)
   - type: web
     name: tutorverse-backend
     runtime: docker
     region: oregon
     dockerfilePath: ./Dockerfile.backend
     autoDeploy: true
     healthCheckPath: /health
     healthCheckStartPeriod: 60
     envVars:
       - key: NODE_ENV
         value: production
       - key: AWS_REGION
         value: us-east-2
       - key: ENVIRONMENT
         value: production
       - key: S3_BUCKET
         value: aitutor-files-production-975050334073
         sync: false
       - key: CORS_ORIGIN
         value: 'https://ai-tutor-ocue.onrender.com'
         sync: false
       - key: FRONTEND_URL
         value: https://ai-tutor-ocue.onrender.com
         sync: false
       - key: RAG_SERVICE_URL
         # IMPORTANT: Replace with actual RAG service URL after deployment
         # Format: https://tutorverse-rag.onrender.com
         value: https://tutorverse-rag.onrender.com
         sync: false
       - key: RAG_ENABLE
         value: 'true'
       - key: RAG_TIMEOUT
         value: '180000'
       - key: RAG_RETRY_ATTEMPTS
         value: '3'

  # Frontend Service (DEPLOY THIRD)
   - type: web
     name: ai-tutor
     runtime: docker
     region: oregon
     dockerfilePath: ./Dockerfile.frontend
     autoDeploy: true
     healthCheckPath: /
     healthCheckStartPeriod: 30
     envVars:
       - key: BACKEND_URL
         # Must be HTTP for internal Render communication (no SSL verification needed)
         value: http://tutorverse-backend-kpls.onrender.com
         sync: false
       - key: NODE_ENV
         value: production
     buildEnv:
       VITE_API_URL: https://tutorverse-backend-kpls.onrender.com
       VITE_API_BASE_URL: https://tutorverse-backend-kpls.onrender.com/api
       VITE_BACKEND_URL: https://tutorverse-backend-kpls.onrender.com
       NODE_ENV: production
       # Service URL: https://ai-tutor.onrender.com
