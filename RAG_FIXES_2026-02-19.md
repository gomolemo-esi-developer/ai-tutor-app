# RAG Service Issues - Fixes Applied (2026-02-19)

## Issues Identified

### Issue 1: "RAG response is not a valid object" 
**Root Cause**: The TypeScript RAG client was trying to parse a streaming NDJSON response using `response.data.split('\n')`, but axios by default parses the response as JSON when it's multipart. This causes the entire stream to be lost or improperly parsed.

**Files Changed**:
- `ai-tutor-app/backend/src/services/rag.service.ts` - `uploadDocument()` method

**Fixes**:
1. Added `responseType: 'stream'` to the axios request to properly handle NDJSON streaming
2. Implemented proper stream event handlers (`data`, `end`, `error`)
3. Added buffer management to handle incomplete lines across chunks
4. Properly validate response structure before returning
5. Added logging for each status update to track progress

### Issue 2: Memory Exhaustion (Out of Memory 512MB)
**Root Cause**: RAG service container was running with default unlimited memory and running large audio processing (37MB MP3 file) which requires temporary space for transcription/conversion.

**Files Changed**:
- `docker-compose.yml`

**Fixes**:
1. **RAG Service**: Increased memory limit from 512MB (default) to 2GB with swap limit
   ```yaml
   mem_limit: 2g
   memswap_limit: 2g
   ```

2. **Backend Service**: Set explicit memory limits to prevent runaway memory usage
   ```yaml
   mem_limit: 512m
   memswap_limit: 512m
   ```

### Issue 3: Request Timeout During Audio Processing
**Root Cause**: Audio file transcription (via Whisper) takes 15-20 seconds. Backend timeout was set to only 30 seconds, but some requests were failing with "stream has been aborted" error due to timeout.

**Files Changed**:
- `docker-compose.yml`

**Fixes**:
1. Increased `RAG_TIMEOUT` from 30 seconds to 180 seconds (3 minutes)
   ```yaml
   - RAG_TIMEOUT=180000  # 3 minutes for large file processing
   ```

2. Added `RAG_RETRY_DELAY_MS` configuration for exponential backoff
   ```yaml
   - RAG_RETRY_DELAY_MS=2000  # Start with 2s delay between retries
   ```

### Issue 4: Health Check Returns 307 Redirect
**Root Cause**: Health check endpoint path mismatch. FastAPI router with prefix `/health` creates endpoint `/health/` (with trailing slash), but Docker health check was calling `/health` (without trailing slash), causing FastAPI to redirect with 307.

**Files Changed**:
- `Dockerfile.rag`
- `ai-tutor-app/backend/src/services/rag.service.ts`

**Fixes**:
1. Updated Docker health check to use `/health/` with trailing slash
   ```dockerfile
   CMD curl -f http://localhost:8000/health/ || exit 1
   ```

2. Updated RAG service health check method to use `/health/`
   ```typescript
   const response = await this.client.get('/health/', { timeout: 5000 });
   ```

## Summary of Changes

### Memory Configuration
```yaml
RAG Service:
- mem_limit: 2g (was unlimited)
- memswap_limit: 2g (was unlimited)

Backend Service:
- mem_limit: 512m (new)
- memswap_limit: 512m (new)
```

### Timeout Configuration
```yaml
RAG_TIMEOUT: 180000ms (was 30000ms) - 6x increase
RAG_RETRY_DELAY_MS: 2000ms (new) - exponential backoff
```

### Stream Handling
- Changed from synchronous string parsing to proper async stream handling
- Implemented event-based architecture (data, end, error events)
- Added buffer management for incomplete lines across TCP packets

## Testing Recommendations

1. **Test with large audio file**:
   - Upload the 37MB MP3 file again
   - Monitor memory usage (should stay under 2GB)
   - Check that upload completes successfully in 3 minutes

2. **Test retry logic**:
   - Simulate timeout by setting short initial timeout
   - Verify exponential backoff (1s, 2s, 4s delays)
   - Confirm request succeeds on retry

3. **Test health checks**:
   - Verify `/health/` endpoint returns 200 OK
   - Confirm Docker health checks pass
   - Check service stays healthy during file processing

## Expected Results

After these fixes:
1. ✅ Audio files should upload successfully without "RAG response is not a valid object" error
2. ✅ RAG service should not run out of memory during processing
3. ✅ Requests should not timeout during audio transcription
4. ✅ Health checks should properly report service status
5. ✅ Document chunks should be viewable in the UI after successful upload
